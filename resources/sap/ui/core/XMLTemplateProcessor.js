/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/base/DataType','sap/ui/base/ManagedObject','sap/ui/core/CustomData','./mvc/View','./ExtensionPoint','./StashedControlSupport'],function(q,D,M,C,V,E,S){"use strict";function p(t,v,n,c){var b=M.bindingParser(v,c,true);if(b&&typeof b==="object"){return b;}var a=v=b||v;var T=D.getType(t);if(T){if(T instanceof D){a=T.parseValue(v);}}else{throw new Error("Property "+n+" has unknown type "+t);}return typeof a==="string"?M.bindingParser.escape(a):a;}function l(x){return x.localName||x.baseName||x.nodeName;}var X={};X.loadTemplate=function(t,s){var r=q.sap.getResourceName(t,"."+(s||"view")+".xml");return q.sap.loadResource(r).documentElement;};X.parseViewAttributes=function(x,v,s){var a=v.getMetadata().getAllProperties();for(var i=0;i<x.attributes.length;i++){var b=x.attributes[i];if(b.name==='controllerName'){v._controllerName=b.value;}else if(b.name==='resourceBundleName'){v._resourceBundleName=b.value;}else if(b.name==='resourceBundleUrl'){v._resourceBundleUrl=b.value;}else if(b.name==='resourceBundleLocale'){v._resourceBundleLocale=b.value;}else if(b.name==='resourceBundleAlias'){v._resourceBundleAlias=b.value;}else if(b.name==='class'){v.addStyleClass(b.value);}else if(!s[b.name]&&a[b.name]){s[b.name]=p(a[b.name].type,b.value,b.name,v._oContainingView.oController);}}};var e=false;X.enrichTemplateIds=function(x,v){var r=(e!==false);e=true;try{X.parseTemplate(x,v);}finally{e=r;}return x;};X.parseTemplate=function(x,v){var d=sap.ui.getCore().getConfiguration().getDesignMode();var r=[];if(d){v._sapui_declarativeSourceInfo={xmlNode:x,xmlRootNode:v._oContainingView===v?x:v._oContainingView._sapui_declarativeSourceInfo.xmlRootNode};}var c=v.sViewName||v._sFragmentName;if(!c){var t=v;var L=0;while(++L<1000&&t&&t!==t._oContainingView){t=t._oContainingView;}c=t.sViewName;}if(v.isSubView()){f(x,true);}else{if(x.localName==="View"&&x.namespaceURI!=="sap.ui.core.mvc"){q.sap.log.warning("XMLView root node must have the 'sap.ui.core.mvc' namespace, not '"+x.namespaceURI+"'"+(c?" (View name: "+c+")":""));}g(x);}return r;function a(i){return i;}function b(i){return v._oContainingView.createId(i);}function f(x,R,I){if(x.nodeType===1){var j=l(x);if(x.namespaceURI==="http://www.w3.org/1999/xhtml"||x.namespaceURI==="http://www.w3.org/2000/svg"){r.push("<"+j+" ");var H=false;for(var i=0;i<x.attributes.length;i++){var u=x.attributes[i];var w=u.value;if(u.name==="id"){H=true;w=o(v,x);}r.push(u.name+"=\""+q.sap.encodeHTML(w)+"\" ");}if(R===true){r.push("data-sap-ui-preserve"+"=\""+v.getId()+"\" ");if(!H){r.push("id"+"=\""+v.getId()+"\" ");}}r.push(">");if(window.HTMLTemplateElement&&x instanceof HTMLTemplateElement&&x.content instanceof DocumentFragment){g(x.content);}else{g(x);}r.push("</"+j+">");}else if(j==="FragmentDefinition"&&x.namespaceURI==="sap.ui.core"){g(x,false,true);}else{var y=m(x);for(var i=0;i<y.length;i++){var z=y[i];if(v.getMetadata().hasAggregation("content")){v.addAggregation("content",z);}else if(v.getMetadata().hasAssociation(("content"))){v.addAssociation("content",z);}r.push(z);}}}else if(x.nodeType===3&&!I){var A=x.textContent||x.text,B=l(x.parentNode);if(A){if(B!="style"){A=q.sap.encodeHTML(A);}r.push(A);}}}function g(x,R,I){var j=x.childNodes;for(var i=0;i<j.length;i++){f(j[i],R,I);}}function h(N,i){var j;var u=sap.ui.getCore().getLoadedLibraries();q.each(u,function(y,z){if(N===z.namespace||N===z.name){j=z.name+"."+((z.tagNames&&z.tagNames[i])||i);}});j=j||N+"."+i;q.sap.require(j);var w=q.sap.getObject(j);if(w){return w;}else{q.sap.log.error("Can't find object class '"+j+"' for XML-view","","XMLTemplateProcessor.js");}}function k(i){if(i.namespaceURI==="http://www.w3.org/1999/xhtml"||i.namespaceURI==="http://www.w3.org/2000/svg"){var j=i.attributes['id']?i.attributes['id'].textContent||i.attributes['id'].text:null;if(e){X.enrichTemplateIds(i,v);return[];}else{var u=sap.ui.requireSync("sap/ui/core/mvc/XMLView");return[new u({id:j?o(v,i,j):undefined,xmlNode:i,containingView:v._oContainingView})];}}else{return m(i);}}function m(j){if(l(j)==="ExtensionPoint"&&j.namespaceURI==="sap.ui.core"){if(e){return[];}else{return E(v,j.getAttribute("name"),function(){var u=j.childNodes;var w=[];for(var i=0;i<u.length;i++){var y=u[i];if(y.nodeType===1){w=q.merge(w,k(y));}}return w;});}}else{return n(j);}}function n(u){var w=u.namespaceURI,y=h(w,l(u)),z={},A="",B=[],F=null;if(!y){return[];}var G=y.getMetadata();var K=G.getAllSettings();if(!e){for(var i=0;i<u.attributes.length;i++){var H=u.attributes[i],N=H.name,I=K[N],J=H.value;if(N==="id"){z[N]=o(v,u,J);}else if(N==="class"){A+=J;}else if(N==="viewName"){z[N]=J;}else if(N==="fragmentName"){z[N]=J;z['containingView']=v._oContainingView;}else if((N==="binding"&&!I)||N==='objectBindings'){var O=M.bindingParser(J,v._oContainingView.oController);if(O){z.objectBindings=z.objectBindings||{};z.objectBindings[O.model||undefined]=O;}}else if(N==='metadataContexts'){var P;if(X._preprocessMetadataContexts){P=X._preprocessMetadataContexts(y.getMetadata().getName(),u,v._oContainingView.oController);}if(P){z.metadataContexts=z.metadataContexts||{};z.metadataContexts[P.model||undefined]=P;}}else if(N.indexOf(":")>-1){if(H.namespaceURI==="http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1"){var Q=l(H);B.push(new C({key:Q,value:p("any",J,Q,v._oContainingView.oController)}));}else if(H.namespaceURI==="http://schemas.sap.com/sapui5/extension/sap.ui.core.support.Support.info/1"){F=J;}else if(N.indexOf("xmlns:")!==0){q.sap.log.warning(v+": XMLView parser encountered and ignored attribute '"+N+"' (value: '"+J+"') with unknown namespace");}}else if(I&&I._iKind===0){z[N]=p(I.type,J,N,v._oContainingView.oController);}else if(I&&I._iKind===1&&I.altTypes){z[N]=p(I.altTypes[0],J,N,v._oContainingView.oController);}else if(I&&I._iKind===2){var O=M.bindingParser(J,v._oContainingView.oController);if(O){z[N]=O;}else{q.sap.log.error(v+": aggregations with cardinality 0..n only allow binding paths as attribute value (wrong value: "+N+"='"+J+"')");}}else if(I&&I._iKind===3){z[N]=b(J);}else if(I&&I._iKind===4){z[N]=J.split(/[\s,]+/g).filter(a).map(b);}else if(I&&I._iKind===5){var R=V._resolveEventHandler(J,v._oContainingView.oController);if(R){z[N]=R;}else{q.sap.log.warning(v+": event handler function \""+J+"\" is not a function or does not exist in the controller.");}}else if(I&&I._iKind===-1){if(V.prototype.isPrototypeOf(y.prototype)&&N=="async"){z[N]=p(I.type,J,N,v._oContainingView.oController);}else{q.sap.log.warning(v+": setting '"+N+"' for class "+G.getName()+" (value:'"+J+"') is not supported");}}else{if(X._supportInfo){X._supportInfo({context:u,env:{caller:"createRegularControls",error:true,info:"unknown setting '"+N+"' for class "+G.getName()}});}}}if(B.length>0){z.customData=B;}}function T(u,W,Y){var j;for(j=u.firstChild;j;j=j.nextSibling){U(u,W,Y,j);}}function U(u,W,Y,c1,d1){var e1;if(c1.nodeType===1){if(c1.namespaceURI==="http://schemas.sap.com/sapui5/extension/sap.ui.core.xmlcomposite/1"||c1.namespaceURI==="http://schemas.sap.com/sapui5/extension/sap.ui.core.fragmentcontrol/1"){z[l(c1)]=c1.querySelector("*");return;}e1=c1.namespaceURI===w&&Y&&Y[l(c1)];if(e1){T(c1,e1);}else if(W){if(!d1&&c1.getAttribute("stashed")==="true"&&!e){S.createStashedControl(o(v,c1),{sParentId:z["id"],sParentAggregationName:W.name,fnCreate:function(){return U(u,W,Y,c1,true);}});return;}var f1=k(c1);for(var j=0;j<f1.length;j++){var g1=f1[j];var h1=W.name;if(W.multiple){if(!z[h1]){z[h1]=[];}if(typeof z[h1].path==="string"){z[h1].template=g1;}else{z[h1].push(g1);}}else{z[h1]=g1;}}return f1;}else if(l(u)!=="FragmentDefinition"||u.namespaceURI!=="sap.ui.core"){throw new Error("Cannot add direct child without default aggregation defined for control "+G.getElementName());}}else if(c1.nodeType===3){if(q.trim(c1.textContent||c1.text)){throw new Error("Cannot add text nodes as direct child of an aggregation. For adding text to an aggregation, a surrounding html tag is needed: "+q.trim(c1.textContent||c1.text));}}return[];}var W=G.getDefaultAggregation();var Y=G.getAllAggregations();T(u,W,Y);var Z;if(e&&u.hasAttribute("id")){s(v,u);}else if(!e){if(V.prototype.isPrototypeOf(y.prototype)&&typeof y._sType==="string"){Z=sap.ui.view(z,undefined,y._sType);}else{Z=new y(z);}if(A&&Z.addStyleClass){Z.addStyleClass(A);}}if(!Z){Z=[];}else if(!Array.isArray(Z)){Z=[Z];}if(X._supportInfo&&Z){for(var i=0,$=Z.length;i<$;i++){var _=Z[i];if(_&&_.getId()){var a1=X._supportInfo({context:u,env:{caller:"createRegularControls",nodeid:u.getAttribute("id"),controlid:_.getId()}}),b1=F?F+",":"";b1+=a1;X._supportInfo.addSupportInfo(_.getId(),b1);}}}if(d){Z.forEach(function(_){_._sapui_declarativeSourceInfo={xmlNode:u,xmlRootNode:v._sapui_declarativeSourceInfo.xmlRootNode,fragmentName:G.getName()==='sap.ui.core.Fragment'?z['fragmentName']:null};});}return Z;}function o(v,x,i){if(x.getAttributeNS("http://schemas.sap.com/sapui5/extension/sap.ui.core.Internal/1","id")){return x.getAttribute("id");}else{return b(i?i:x.getAttribute("id"));}}function s(v,x){x.setAttribute("id",b(x.getAttribute("id")));x.setAttributeNS("http://schemas.sap.com/sapui5/extension/sap.ui.core.Internal/1","id",true);}};X._preprocessMetadataContexts=null;return X;},true);
